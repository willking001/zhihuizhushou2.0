# 端口配置说明

## 问题描述

在开发过程中，API代理端口经常发生变化，主要原因是：

1. **Docker容器后端服务** 和 **本地开发后端服务** 都使用8082端口
2. 前端代理配置需要根据使用的后端服务进行调整
3. 缺乏统一的端口管理策略

## 端口分配方案

### 开发环境（推荐）
- **后端服务**: 8082 (本地Maven启动)
- **前端服务**: 5173 (Vite开发服务器)
- **数据库**: 3306 (Docker MySQL)
- **Redis**: 6379 (Docker Redis)

### 生产环境（Docker）
- **后端服务**: 8082 (Docker容器)
- **前端服务**: 通过Nginx代理
- **Nginx**: 8088 (外部访问)

## 解决方案

### 1. 开发环境配置

#### 停止Docker后端容器
```bash
docker stop dianxiaozhu-backend
```

#### 确保后端配置使用8082端口
文件: `backend/src/main/resources/application.properties`
```properties
# 统一使用8082端口
server.port=8082
```

#### 确保前端代理指向8082
文件: `frontend/vite.config.ts`
```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:8082',
      changeOrigin: true
    }
  }
}
```

### 2. 启动顺序

#### 开发环境启动顺序
1. 启动基础服务（数据库、Redis等）
   ```bash
   docker-compose up -d mysql redis
   ```

2. 启动后端服务
   ```bash
   cd backend
   mvn spring-boot:run
   ```

3. 启动前端服务
   ```bash
   cd frontend
   npm run dev
   ```

#### 生产环境启动
```bash
docker-compose up -d
```

### 3. 端口检查脚本

创建 `check-ports.bat` 脚本：
```batch
@echo off
echo 检查端口占用情况...
echo.
echo 8082端口占用情况:
netstat -ano | findstr :8082
echo.
echo 5173端口占用情况:
netstat -ano | findstr :5173
echo.
echo 3306端口占用情况:
netstat -ano | findstr :3306
```

### 4. 环境切换

#### 切换到开发环境
```bash
# 停止Docker后端
docker stop dianxiaozhu-backend

# 启动本地后端
cd backend && mvn spring-boot:run
```

#### 切换到Docker环境
```bash
# 停止本地后端（Ctrl+C）

# 启动Docker后端
docker start dianxiaozhu-backend
```

## 最佳实践

1. **开发时使用本地后端**: 便于调试和热重载
2. **测试时使用Docker后端**: 模拟生产环境
3. **统一端口配置**: 避免频繁修改配置文件
4. **文档化端口分配**: 团队成员都了解端口使用情况

## 常见问题

### Q: 8082端口被占用怎么办？
A: 
1. 检查是否有Docker后端容器在运行: `docker ps | findstr backend`
2. 停止Docker后端容器: `docker stop dianxiaozhu-backend`
3. 检查其他进程: `netstat -ano | findstr :8082`

### Q: 前端无法连接后端？
A:
1. 确认后端服务正在运行在8082端口
2. 检查前端代理配置是否正确
3. 确认防火墙没有阻止连接

### Q: 如何永久固定端口配置？
A:
1. 在项目根目录创建 `.env.local` 文件
2. 定义环境变量
3. 在配置文件中引用环境变量

## 环境变量配置（推荐）

创建 `.env.local` 文件：
```env
# 后端服务端口
BACKEND_PORT=8082

# 前端服务端口
FRONTEND_PORT=5173

# 数据库端口
DB_PORT=3306

# Redis端口
REDIS_PORT=6379
```

这样可以确保所有开发者使用相同的端口配置，避免端口冲突问题。