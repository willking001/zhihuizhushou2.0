# 电小助 2.0 技术架构说明

## 数据持久化架构

### 当前架构概述

电小助 2.0 系统采用 **MyBatis + JPA/Hibernate 混合架构**，针对不同业务模块使用不同的持久化技术：

- **MyBatis**: 用于关键词管理相关模块（已迁移）
- **JPA/Hibernate**: 用于其他业务模块（广泛使用）

### Hibernate 使用现状

系统中仍有大量模块使用 Hibernate 技术栈：

#### 实体类（Entity）
- 14个实体类使用 JPA 注解：`@Entity`, `@Table`, `@Id`, `@Column` 等
- 复杂关联关系：`@OneToMany`, `@ManyToOne`, `@JoinColumn`
- 自动主键生成：`@GeneratedValue(strategy = GenerationType.IDENTITY)`

#### Repository 层
- 14个 Repository 接口继承 `JpaRepository`
- 使用 Spring Data JPA 派生查询方法
- 部分使用 `@Query` 注解自定义 JPQL 查询
- `UserRepository` 使用 `JpaSpecificationExecutor` 进行动态查询

#### Service 层
- 广泛使用 `@Transactional` 注解进行事务管理
- `UserService` 使用 JPA Specification 和 Criteria API 进行复杂查询
- 多个服务类依赖 JPA 的自动事务管理

### 架构选择原因

#### MyBatis 适用场景
- **复杂查询需求**: 关键词模块需要复杂的条件查询和统计分析
- **性能优化**: 手动编写SQL，更好地控制查询性能
- **灵活性**: 支持动态SQL，适应多变的业务查询需求

#### JPA 适用场景
- **标准CRUD操作**: 大部分业务模块的基础增删改查
- **开发效率**: 自动生成SQL，减少开发工作量
- **对象关系映射**: 复杂的实体关系映射

## 模块分布

### MyBatis 模块

#### 关键词管理模块
- **KeywordConfigMapper**: 关键词配置数据访问
- **KeywordConfigService**: 关键词业务逻辑
- **KeywordTriggerService**: 关键词触发服务
- **KeywordLearningService**: 关键词学习服务
- **KeywordCompatibilityService**: 关键词兼容性服务
- **KeywordManagementService**: 关键词管理服务
- **KeywordSyncService**: 关键词同步服务

**特点**:
- 使用 XML 映射文件定义复杂查询
- 支持动态SQL和条件查询
- 手动管理事务和缓存
- 客户端过滤替代复杂的数据库查询

### JPA/Hibernate 模块

#### 用户管理模块
- **User** 实体：使用 `@Entity`, `@Table`, `@Column` 等 JPA 注解
- **UserRepository**: 继承 `JpaRepository` 和 `JpaSpecificationExecutor`
- **UserService**: 使用 JPA Specification 和 Criteria API 进行动态查询
- **事务管理**: 7个方法使用 `@Transactional` 注解

#### 消息管理模块
- **Message** 实体：使用完整的 JPA 注解映射
- **MessageTemplate** 实体：使用 `@CollectionTable` 和 `@JoinColumn` 进行集合映射
- **MessageRepository**: 标准 JPA Repository
- **MessageTemplateRepository**: 标准 JPA Repository
- **MessageService**: 使用 `@Transactional` 进行事务管理

#### 业务规则模块
- **BusinessRule** 实体：使用 `@OneToMany` 关联关系
- **RuleAction**, **RuleCondition** 实体：使用 `@ManyToOne` 和 `@JoinColumn`
- **RuleChain**, **RuleChainRelation** 实体：复杂的链式关联关系
- **RuleExecutionLog** 实体：使用 `@ManyToOne` 关联到业务规则
- **对应 Repository**: 全部继承 `JpaRepository`
- **对应 Service**: 大量使用 `@Transactional` 注解（共计30+个事务方法）

#### 群组管理模块
- **GroupManagementStatus** 实体：群组状态管理
- **GroupDailyStatistics** 实体：群组统计数据
- **对应 Repository**: 使用 JPA 派生查询和 `@Query` 注解
- **GroupManagementService**: 7个方法使用 `@Transactional`

#### 系统配置模块
- **SystemConfig** 实体：系统配置管理
- **NlpConfig**, **NlpResult** 实体：NLP 相关配置和结果
- **对应 Repository**: 标准 JPA Repository
- **SystemConfigServiceImpl**: 5个方法使用 `@Transactional`

**JPA/Hibernate 特点**:
- 使用 Spring Data JPA 派生查询（如 `findByTypeAndEnabled`）
- 自动生成标准CRUD操作
- 支持 `@Query` 注解自定义 JPQL 查询
- 使用 JPA Specification 进行动态查询（UserService）
- 使用 Criteria API 构建复杂查询条件
- 自动事务管理和二级缓存
- Hibernate 自动 DDL 生成（`spring.jpa.hibernate.ddl-auto=update`）

## 配置说明

### 依赖配置

```xml
<!-- MyBatis 依赖 -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>3.0.3</version>
</dependency>

<!-- JPA 依赖（其他模块仍在使用） -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

### 应用配置

```properties
# MyBatis配置
spring.profiles.include=mybatis

# JPA配置（Docker环境）
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

### MyBatis 配置文件

**application-mybatis.properties**:
```properties
# MyBatis 配置
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.dianxiaozhu.backend.entity
mybatis.configuration.map-underscore-to-camel-case=true
mybatis.configuration.use-generated-keys=true
mybatis.configuration.default-fetch-size=100
mybatis.configuration.default-statement-timeout=30
```

## 迁移策略

### 已完成迁移

✅ **关键词配置模块** (KeywordConfig)
- 从 `KeywordConfigRepository` 迁移到 `KeywordConfigMapper`
- 实现了25个派生查询方法的MyBatis等价实现
- 保持了所有业务逻辑和缓存策略

### 迁移模式

1. **Repository → Mapper**: JPA Repository 接口转换为 MyBatis Mapper 接口
2. **派生查询 → XML映射**: Spring Data 派生查询转换为 XML SQL 映射
3. **客户端过滤**: 复杂查询改为客户端 Java Stream 过滤
4. **手动时间戳**: 替代 JPA 的自动 `@CreatedDate` 和 `@LastModifiedDate`

### 未来迁移计划

🔄 **待评估模块**:
- 用户管理模块 (复杂查询较多)
- 业务规则模块 (关联查询复杂)
- 群组统计模块 (聚合查询较多)

📋 **保持JPA模块**:
- 系统配置模块 (简单CRUD)
- 消息模板模块 (标准操作)
- NLP配置模块 (基础查询)

## 最佳实践

### MyBatis 开发规范

1. **Mapper接口**: 使用 `@Mapper` 注解
2. **XML映射**: 放置在 `src/main/resources/mapper/` 目录
3. **命名规范**: Mapper接口与XML文件同名
4. **参数绑定**: 使用 `@Param` 注解明确参数名
5. **结果映射**: 配置 `map-underscore-to-camel-case=true`

### JPA 开发规范

1. **Repository接口**: 继承 `JpaRepository<Entity, ID>`
2. **派生查询**: 遵循 Spring Data 命名规范
3. **自定义查询**: 使用 `@Query` 注解
4. **事务管理**: 使用 `@Transactional` 注解
5. **实体映射**: 使用标准 JPA 注解

### 混合架构注意事项

1. **事务一致性**: 确保跨模块操作的事务边界
2. **缓存策略**: MyBatis 和 JPA 使用不同的缓存机制
3. **性能监控**: 分别监控两种技术的性能表现
4. **团队培训**: 确保团队熟悉两种技术栈

## 性能对比

### MyBatis 优势
- ✅ SQL 控制精确，性能优化空间大
- ✅ 复杂查询编写灵活
- ✅ 减少 N+1 查询问题
- ✅ 内存使用更可控

### JPA 优势
- ✅ 开发效率高，代码量少
- ✅ 对象关系映射自动化
- ✅ 标准化程度高
- ✅ 二级缓存支持完善

## 监控和维护

### 性能监控
- **MyBatis**: 使用 MyBatis-Plus 监控插件
- **JPA**: 使用 Hibernate 统计信息
- **数据库**: 监控慢查询日志

### 日志配置
```properties
# MyBatis SQL 日志
logging.level.com.dianxiaozhu.backend.mapper=DEBUG

# JPA SQL 日志
spring.jpa.show-sql=true
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

---

**文档版本**: v1.0  
**更新时间**: 2025-08-13  
**维护人员**: 开发团队