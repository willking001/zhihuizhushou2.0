# ç”µå°åŠ© 2.0 æŠ€æœ¯æ¶æ„è¯´æ˜

## æ•°æ®æŒä¹…åŒ–æ¶æ„

### å½“å‰æ¶æ„æ¦‚è¿°

ç”µå°åŠ© 2.0 ç³»ç»Ÿé‡‡ç”¨ **MyBatis + JPA/Hibernate æ··åˆæ¶æ„**ï¼Œé’ˆå¯¹ä¸åŒä¸šåŠ¡æ¨¡å—ä½¿ç”¨ä¸åŒçš„æŒä¹…åŒ–æŠ€æœ¯ï¼š

- **MyBatis**: ç”¨äºå…³é”®è¯ç®¡ç†ç›¸å…³æ¨¡å—ï¼ˆå·²è¿ç§»ï¼‰
- **JPA/Hibernate**: ç”¨äºå…¶ä»–ä¸šåŠ¡æ¨¡å—ï¼ˆå¹¿æ³›ä½¿ç”¨ï¼‰

### Hibernate ä½¿ç”¨ç°çŠ¶

ç³»ç»Ÿä¸­ä»æœ‰å¤§é‡æ¨¡å—ä½¿ç”¨ Hibernate æŠ€æœ¯æ ˆï¼š

#### å®ä½“ç±»ï¼ˆEntityï¼‰
- 14ä¸ªå®ä½“ç±»ä½¿ç”¨ JPA æ³¨è§£ï¼š`@Entity`, `@Table`, `@Id`, `@Column` ç­‰
- å¤æ‚å…³è”å…³ç³»ï¼š`@OneToMany`, `@ManyToOne`, `@JoinColumn`
- è‡ªåŠ¨ä¸»é”®ç”Ÿæˆï¼š`@GeneratedValue(strategy = GenerationType.IDENTITY)`

#### Repository å±‚
- 14ä¸ª Repository æ¥å£ç»§æ‰¿ `JpaRepository`
- ä½¿ç”¨ Spring Data JPA æ´¾ç”ŸæŸ¥è¯¢æ–¹æ³•
- éƒ¨åˆ†ä½¿ç”¨ `@Query` æ³¨è§£è‡ªå®šä¹‰ JPQL æŸ¥è¯¢
- `UserRepository` ä½¿ç”¨ `JpaSpecificationExecutor` è¿›è¡ŒåŠ¨æ€æŸ¥è¯¢

#### Service å±‚
- å¹¿æ³›ä½¿ç”¨ `@Transactional` æ³¨è§£è¿›è¡Œäº‹åŠ¡ç®¡ç†
- `UserService` ä½¿ç”¨ JPA Specification å’Œ Criteria API è¿›è¡Œå¤æ‚æŸ¥è¯¢
- å¤šä¸ªæœåŠ¡ç±»ä¾èµ– JPA çš„è‡ªåŠ¨äº‹åŠ¡ç®¡ç†

### æ¶æ„é€‰æ‹©åŸå› 

#### MyBatis é€‚ç”¨åœºæ™¯
- **å¤æ‚æŸ¥è¯¢éœ€æ±‚**: å…³é”®è¯æ¨¡å—éœ€è¦å¤æ‚çš„æ¡ä»¶æŸ¥è¯¢å’Œç»Ÿè®¡åˆ†æ
- **æ€§èƒ½ä¼˜åŒ–**: æ‰‹åŠ¨ç¼–å†™SQLï¼Œæ›´å¥½åœ°æ§åˆ¶æŸ¥è¯¢æ€§èƒ½
- **çµæ´»æ€§**: æ”¯æŒåŠ¨æ€SQLï¼Œé€‚åº”å¤šå˜çš„ä¸šåŠ¡æŸ¥è¯¢éœ€æ±‚

#### JPA é€‚ç”¨åœºæ™¯
- **æ ‡å‡†CRUDæ“ä½œ**: å¤§éƒ¨åˆ†ä¸šåŠ¡æ¨¡å—çš„åŸºç¡€å¢åˆ æ”¹æŸ¥
- **å¼€å‘æ•ˆç‡**: è‡ªåŠ¨ç”ŸæˆSQLï¼Œå‡å°‘å¼€å‘å·¥ä½œé‡
- **å¯¹è±¡å…³ç³»æ˜ å°„**: å¤æ‚çš„å®ä½“å…³ç³»æ˜ å°„

## æ¨¡å—åˆ†å¸ƒ

### MyBatis æ¨¡å—

#### å…³é”®è¯ç®¡ç†æ¨¡å—
- **KeywordConfigMapper**: å…³é”®è¯é…ç½®æ•°æ®è®¿é—®
- **KeywordConfigService**: å…³é”®è¯ä¸šåŠ¡é€»è¾‘
- **KeywordTriggerService**: å…³é”®è¯è§¦å‘æœåŠ¡
- **KeywordLearningService**: å…³é”®è¯å­¦ä¹ æœåŠ¡
- **KeywordCompatibilityService**: å…³é”®è¯å…¼å®¹æ€§æœåŠ¡
- **KeywordManagementService**: å…³é”®è¯ç®¡ç†æœåŠ¡
- **KeywordSyncService**: å…³é”®è¯åŒæ­¥æœåŠ¡

**ç‰¹ç‚¹**:
- ä½¿ç”¨ XML æ˜ å°„æ–‡ä»¶å®šä¹‰å¤æ‚æŸ¥è¯¢
- æ”¯æŒåŠ¨æ€SQLå’Œæ¡ä»¶æŸ¥è¯¢
- æ‰‹åŠ¨ç®¡ç†äº‹åŠ¡å’Œç¼“å­˜
- å®¢æˆ·ç«¯è¿‡æ»¤æ›¿ä»£å¤æ‚çš„æ•°æ®åº“æŸ¥è¯¢

### JPA/Hibernate æ¨¡å—

#### ç”¨æˆ·ç®¡ç†æ¨¡å—
- **User** å®ä½“ï¼šä½¿ç”¨ `@Entity`, `@Table`, `@Column` ç­‰ JPA æ³¨è§£
- **UserRepository**: ç»§æ‰¿ `JpaRepository` å’Œ `JpaSpecificationExecutor`
- **UserService**: ä½¿ç”¨ JPA Specification å’Œ Criteria API è¿›è¡ŒåŠ¨æ€æŸ¥è¯¢
- **äº‹åŠ¡ç®¡ç†**: 7ä¸ªæ–¹æ³•ä½¿ç”¨ `@Transactional` æ³¨è§£

#### æ¶ˆæ¯ç®¡ç†æ¨¡å—
- **Message** å®ä½“ï¼šä½¿ç”¨å®Œæ•´çš„ JPA æ³¨è§£æ˜ å°„
- **MessageTemplate** å®ä½“ï¼šä½¿ç”¨ `@CollectionTable` å’Œ `@JoinColumn` è¿›è¡Œé›†åˆæ˜ å°„
- **MessageRepository**: æ ‡å‡† JPA Repository
- **MessageTemplateRepository**: æ ‡å‡† JPA Repository
- **MessageService**: ä½¿ç”¨ `@Transactional` è¿›è¡Œäº‹åŠ¡ç®¡ç†

#### ä¸šåŠ¡è§„åˆ™æ¨¡å—
- **BusinessRule** å®ä½“ï¼šä½¿ç”¨ `@OneToMany` å…³è”å…³ç³»
- **RuleAction**, **RuleCondition** å®ä½“ï¼šä½¿ç”¨ `@ManyToOne` å’Œ `@JoinColumn`
- **RuleChain**, **RuleChainRelation** å®ä½“ï¼šå¤æ‚çš„é“¾å¼å…³è”å…³ç³»
- **RuleExecutionLog** å®ä½“ï¼šä½¿ç”¨ `@ManyToOne` å…³è”åˆ°ä¸šåŠ¡è§„åˆ™
- **å¯¹åº” Repository**: å…¨éƒ¨ç»§æ‰¿ `JpaRepository`
- **å¯¹åº” Service**: å¤§é‡ä½¿ç”¨ `@Transactional` æ³¨è§£ï¼ˆå…±è®¡30+ä¸ªäº‹åŠ¡æ–¹æ³•ï¼‰

#### ç¾¤ç»„ç®¡ç†æ¨¡å—
- **GroupManagementStatus** å®ä½“ï¼šç¾¤ç»„çŠ¶æ€ç®¡ç†
- **GroupDailyStatistics** å®ä½“ï¼šç¾¤ç»„ç»Ÿè®¡æ•°æ®
- **å¯¹åº” Repository**: ä½¿ç”¨ JPA æ´¾ç”ŸæŸ¥è¯¢å’Œ `@Query` æ³¨è§£
- **GroupManagementService**: 7ä¸ªæ–¹æ³•ä½¿ç”¨ `@Transactional`

#### ç³»ç»Ÿé…ç½®æ¨¡å—
- **SystemConfig** å®ä½“ï¼šç³»ç»Ÿé…ç½®ç®¡ç†
- **NlpConfig**, **NlpResult** å®ä½“ï¼šNLP ç›¸å…³é…ç½®å’Œç»“æœ
- **å¯¹åº” Repository**: æ ‡å‡† JPA Repository
- **SystemConfigServiceImpl**: 5ä¸ªæ–¹æ³•ä½¿ç”¨ `@Transactional`

**JPA/Hibernate ç‰¹ç‚¹**:
- ä½¿ç”¨ Spring Data JPA æ´¾ç”ŸæŸ¥è¯¢ï¼ˆå¦‚ `findByTypeAndEnabled`ï¼‰
- è‡ªåŠ¨ç”Ÿæˆæ ‡å‡†CRUDæ“ä½œ
- æ”¯æŒ `@Query` æ³¨è§£è‡ªå®šä¹‰ JPQL æŸ¥è¯¢
- ä½¿ç”¨ JPA Specification è¿›è¡ŒåŠ¨æ€æŸ¥è¯¢ï¼ˆUserServiceï¼‰
- ä½¿ç”¨ Criteria API æ„å»ºå¤æ‚æŸ¥è¯¢æ¡ä»¶
- è‡ªåŠ¨äº‹åŠ¡ç®¡ç†å’ŒäºŒçº§ç¼“å­˜
- Hibernate è‡ªåŠ¨ DDL ç”Ÿæˆï¼ˆ`spring.jpa.hibernate.ddl-auto=update`ï¼‰

## é…ç½®è¯´æ˜

### ä¾èµ–é…ç½®

```xml
<!-- MyBatis ä¾èµ– -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>3.0.3</version>
</dependency>

<!-- JPA ä¾èµ–ï¼ˆå…¶ä»–æ¨¡å—ä»åœ¨ä½¿ç”¨ï¼‰ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

### åº”ç”¨é…ç½®

```properties
# MyBatisé…ç½®
spring.profiles.include=mybatis

# JPAé…ç½®ï¼ˆDockerç¯å¢ƒï¼‰
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

### MyBatis é…ç½®æ–‡ä»¶

**application-mybatis.properties**:
```properties
# MyBatis é…ç½®
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.dianxiaozhu.backend.entity
mybatis.configuration.map-underscore-to-camel-case=true
mybatis.configuration.use-generated-keys=true
mybatis.configuration.default-fetch-size=100
mybatis.configuration.default-statement-timeout=30
```

## è¿ç§»ç­–ç•¥

### å·²å®Œæˆè¿ç§»

âœ… **å…³é”®è¯é…ç½®æ¨¡å—** (KeywordConfig)
- ä» `KeywordConfigRepository` è¿ç§»åˆ° `KeywordConfigMapper`
- å®ç°äº†25ä¸ªæ´¾ç”ŸæŸ¥è¯¢æ–¹æ³•çš„MyBatisç­‰ä»·å®ç°
- ä¿æŒäº†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘å’Œç¼“å­˜ç­–ç•¥

### è¿ç§»æ¨¡å¼

1. **Repository â†’ Mapper**: JPA Repository æ¥å£è½¬æ¢ä¸º MyBatis Mapper æ¥å£
2. **æ´¾ç”ŸæŸ¥è¯¢ â†’ XMLæ˜ å°„**: Spring Data æ´¾ç”ŸæŸ¥è¯¢è½¬æ¢ä¸º XML SQL æ˜ å°„
3. **å®¢æˆ·ç«¯è¿‡æ»¤**: å¤æ‚æŸ¥è¯¢æ”¹ä¸ºå®¢æˆ·ç«¯ Java Stream è¿‡æ»¤
4. **æ‰‹åŠ¨æ—¶é—´æˆ³**: æ›¿ä»£ JPA çš„è‡ªåŠ¨ `@CreatedDate` å’Œ `@LastModifiedDate`

### æœªæ¥è¿ç§»è®¡åˆ’

ğŸ”„ **å¾…è¯„ä¼°æ¨¡å—**:
- ç”¨æˆ·ç®¡ç†æ¨¡å— (å¤æ‚æŸ¥è¯¢è¾ƒå¤š)
- ä¸šåŠ¡è§„åˆ™æ¨¡å— (å…³è”æŸ¥è¯¢å¤æ‚)
- ç¾¤ç»„ç»Ÿè®¡æ¨¡å— (èšåˆæŸ¥è¯¢è¾ƒå¤š)

ğŸ“‹ **ä¿æŒJPAæ¨¡å—**:
- ç³»ç»Ÿé…ç½®æ¨¡å— (ç®€å•CRUD)
- æ¶ˆæ¯æ¨¡æ¿æ¨¡å— (æ ‡å‡†æ“ä½œ)
- NLPé…ç½®æ¨¡å— (åŸºç¡€æŸ¥è¯¢)

## æœ€ä½³å®è·µ

### MyBatis å¼€å‘è§„èŒƒ

1. **Mapperæ¥å£**: ä½¿ç”¨ `@Mapper` æ³¨è§£
2. **XMLæ˜ å°„**: æ”¾ç½®åœ¨ `src/main/resources/mapper/` ç›®å½•
3. **å‘½åè§„èŒƒ**: Mapperæ¥å£ä¸XMLæ–‡ä»¶åŒå
4. **å‚æ•°ç»‘å®š**: ä½¿ç”¨ `@Param` æ³¨è§£æ˜ç¡®å‚æ•°å
5. **ç»“æœæ˜ å°„**: é…ç½® `map-underscore-to-camel-case=true`

### JPA å¼€å‘è§„èŒƒ

1. **Repositoryæ¥å£**: ç»§æ‰¿ `JpaRepository<Entity, ID>`
2. **æ´¾ç”ŸæŸ¥è¯¢**: éµå¾ª Spring Data å‘½åè§„èŒƒ
3. **è‡ªå®šä¹‰æŸ¥è¯¢**: ä½¿ç”¨ `@Query` æ³¨è§£
4. **äº‹åŠ¡ç®¡ç†**: ä½¿ç”¨ `@Transactional` æ³¨è§£
5. **å®ä½“æ˜ å°„**: ä½¿ç”¨æ ‡å‡† JPA æ³¨è§£

### æ··åˆæ¶æ„æ³¨æ„äº‹é¡¹

1. **äº‹åŠ¡ä¸€è‡´æ€§**: ç¡®ä¿è·¨æ¨¡å—æ“ä½œçš„äº‹åŠ¡è¾¹ç•Œ
2. **ç¼“å­˜ç­–ç•¥**: MyBatis å’Œ JPA ä½¿ç”¨ä¸åŒçš„ç¼“å­˜æœºåˆ¶
3. **æ€§èƒ½ç›‘æ§**: åˆ†åˆ«ç›‘æ§ä¸¤ç§æŠ€æœ¯çš„æ€§èƒ½è¡¨ç°
4. **å›¢é˜ŸåŸ¹è®­**: ç¡®ä¿å›¢é˜Ÿç†Ÿæ‚‰ä¸¤ç§æŠ€æœ¯æ ˆ

## æ€§èƒ½å¯¹æ¯”

### MyBatis ä¼˜åŠ¿
- âœ… SQL æ§åˆ¶ç²¾ç¡®ï¼Œæ€§èƒ½ä¼˜åŒ–ç©ºé—´å¤§
- âœ… å¤æ‚æŸ¥è¯¢ç¼–å†™çµæ´»
- âœ… å‡å°‘ N+1 æŸ¥è¯¢é—®é¢˜
- âœ… å†…å­˜ä½¿ç”¨æ›´å¯æ§

### JPA ä¼˜åŠ¿
- âœ… å¼€å‘æ•ˆç‡é«˜ï¼Œä»£ç é‡å°‘
- âœ… å¯¹è±¡å…³ç³»æ˜ å°„è‡ªåŠ¨åŒ–
- âœ… æ ‡å‡†åŒ–ç¨‹åº¦é«˜
- âœ… äºŒçº§ç¼“å­˜æ”¯æŒå®Œå–„

## ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§
- **MyBatis**: ä½¿ç”¨ MyBatis-Plus ç›‘æ§æ’ä»¶
- **JPA**: ä½¿ç”¨ Hibernate ç»Ÿè®¡ä¿¡æ¯
- **æ•°æ®åº“**: ç›‘æ§æ…¢æŸ¥è¯¢æ—¥å¿—

### æ—¥å¿—é…ç½®
```properties
# MyBatis SQL æ—¥å¿—
logging.level.com.dianxiaozhu.backend.mapper=DEBUG

# JPA SQL æ—¥å¿—
spring.jpa.show-sql=true
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025-08-13  
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ