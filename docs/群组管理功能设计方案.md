# 群组管理功能设计方案

## 1. 概述

### 1.1 功能目标
基于现有系统架构和人工接管机制设计方案，扩展现有的消息处理、业务规则和系统配置功能，实现对微信群组转发和回复行为的精细化管理，支持自动化和人工干预的无缝切换。

### 1.2 核心功能
- 扩展现有Message实体，增加群组管理字段
- 基于BusinessRule实体，创建群组管理规则
- 利用SystemConfig实体，存储群组全局配置
- 扩展现有Controller，增加群组管理API
- 复用现有Service层，增加群组管理逻辑

### 1.3 与现有系统的集成点
- **Message实体**：已包含chatRoom、isGroup、isForwarded等群组相关字段
- **BusinessRule实体**：可用于定义群组自动化规则
- **SystemConfig实体**：可存储群组管理的全局配置
- **KeywordConfig实体**：可用于群组关键词触发配置
- **现有Controller模式**：遵循统一的API设计规范

## 2. 系统架构设计

### 2.1 整体架构（基于现有系统）
```
现有前端界面 (Vue3 + Element Plus) - 扩展群组管理页面
    ↓
现有API接口层 (Spring Boot) - 扩展MessageController等
    ↓
现有业务逻辑层 (Service) - 扩展MessageService等
    ↓
现有数据访问层 (JPA Repository) - 复用现有Repository
    ↓
现有数据库层 (MySQL) - 扩展现有表结构
```

### 2.2 模块扩展策略
- **消息处理模块**：扩展MessageService，增加群组状态管理
- **业务规则模块**：扩展BusinessRuleService，增加群组规则处理
- **系统配置模块**：扩展SystemConfigService，增加群组配置管理
- **关键词管理模块**：扩展KeywordConfigService，增加群组关键词处理

## 3. 数据库设计（基于现有表结构扩展）

### 3.1 扩展现有Message表
现有Message表已包含群组相关字段，需要添加以下字段来支持群组管理：

```sql
-- 扩展messages表，添加群组管理相关字段
ALTER TABLE messages ADD COLUMN group_status VARCHAR(20) DEFAULT 'AUTO' COMMENT '群组状态: AUTO/MANUAL/PAUSED';
ALTER TABLE messages ADD COLUMN takeover_trigger VARCHAR(50) COMMENT '接管触发类型: KEYWORD/SENTIMENT/REPETITION';
ALTER TABLE messages ADD COLUMN sentiment_score DECIMAL(3,2) COMMENT '情感分析得分';
ALTER TABLE messages ADD COLUMN repetition_count INT DEFAULT 0 COMMENT '重复询问计数';
ALTER TABLE messages ADD COLUMN manual_handled BOOLEAN DEFAULT FALSE COMMENT '是否已人工处理';
ALTER TABLE messages ADD COLUMN handled_by VARCHAR(50) COMMENT '处理人员';
ALTER TABLE messages ADD COLUMN handled_time DATETIME COMMENT '处理时间';

-- 添加索引
CREATE INDEX idx_messages_chat_room_status ON messages(chat_room, group_status);
CREATE INDEX idx_messages_takeover_trigger ON messages(takeover_trigger);
CREATE INDEX idx_messages_manual_handled ON messages(manual_handled);
```

### 3.2 利用现有SystemConfig表存储群组配置
使用现有system_config表存储群组管理的全局配置：

```sql
-- 群组管理相关的系统配置示例
INSERT INTO system_config (config_key, config_value, description, config_type, enabled, create_time, update_time, creator_id, updater_id) VALUES
('group.auto_reply.default', 'true', '群组自动回复默认开关', 'BOOLEAN', true, NOW(), NOW(), 1, 1),
('group.auto_forward.default', 'true', '群组自动转发默认开关', 'BOOLEAN', true, NOW(), NOW(), 1, 1),
('group.sentiment.threshold', '-0.5', '情感分析触发阈值', 'STRING', true, NOW(), NOW(), 1, 1),
('group.repetition.threshold', '3', '重复询问触发阈值', 'INTEGER', true, NOW(), NOW(), 1, 1),
('group.notification.phone', '', '默认通知手机号', 'STRING', true, NOW(), NOW(), 1, 1),
('group.notification.email', '', '默认通知邮箱', 'STRING', true, NOW(), NOW(), 1, 1),
('group.takeover.keywords', '["人工","客服","投诉","不满意"]', '人工接管触发关键词', 'JSON', true, NOW(), NOW(), 1, 1);
```

### 3.3 扩展现有BusinessRule表用于群组规则
利用现有business_rule表创建群组管理规则：

```sql
-- 群组管理相关的业务规则示例
INSERT INTO business_rule (rule_name, rule_description, rule_type, priority, enabled, create_time, update_time, creator_id, remark) VALUES
('群组自动回复规则', '根据关键词自动回复群组消息', 'GROUP_AUTO_REPLY', 1, true, NOW(), NOW(), 1, '群组自动回复核心规则'),
('群组消息转发规则', '满足条件时自动转发群组消息', 'GROUP_MESSAGE_FORWARD', 2, true, NOW(), NOW(), 1, '群组消息转发规则'),
('群组人工接管规则', '检测到特定条件时触发人工接管', 'GROUP_MANUAL_TAKEOVER', 3, true, NOW(), NOW(), 1, '人工接管触发规则'),
('群组情感分析规则', '基于情感分析结果进行处理', 'GROUP_SENTIMENT_ANALYSIS', 4, true, NOW(), NOW(), 1, '情感分析处理规则');
```

### 3.4 扩展现有KeywordConfig表用于群组关键词
利用现有keyword_configs表管理群组相关关键词：

```sql
-- 为群组管理添加关键词类型
ALTER TABLE keyword_configs ADD COLUMN group_id VARCHAR(100) COMMENT '关联群组ID';
ALTER TABLE keyword_configs ADD COLUMN action_type VARCHAR(50) COMMENT '动作类型: AUTO_REPLY/FORWARD/TAKEOVER';

-- 添加索引
CREATE INDEX idx_keyword_configs_group_id ON keyword_configs(group_id);
CREATE INDEX idx_keyword_configs_action_type ON keyword_configs(action_type);

-- 群组关键词配置示例
INSERT INTO keyword_configs (keyword, type, priority, description, grid_area, is_active, created_by, created_at, updated_at, group_id, action_type) VALUES
('人工客服', 'CUSTOM', 'HIGH', '触发人工接管', NULL, true, 1, NOW(), NOW(), NULL, 'TAKEOVER'),
('投诉', 'CUSTOM', 'URGENT', '投诉关键词触发人工接管', NULL, true, 1, NOW(), NOW(), NULL, 'TAKEOVER'),
('不满意', 'CUSTOM', 'HIGH', '不满意情绪触发人工接管', NULL, true, 1, NOW(), NOW(), NULL, 'TAKEOVER'),
('价格咨询', 'CUSTOM', 'NORMAL', '价格相关自动回复', NULL, true, 1, NOW(), NOW(), NULL, 'AUTO_REPLY');
```

### 3.5 新增群组状态管理表（轻量级）
为了更好地管理群组状态，新增一个轻量级的群组状态表：

```sql
CREATE TABLE group_management_status (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    chat_room VARCHAR(200) NOT NULL UNIQUE COMMENT '群组标识（对应messages表的chat_room）',
    group_name VARCHAR(200) COMMENT '群组名称',
    current_status VARCHAR(20) DEFAULT 'AUTO' COMMENT '当前状态: AUTO/MANUAL/PAUSED',
    auto_reply_enabled BOOLEAN DEFAULT TRUE COMMENT '自动回复开关',
    auto_forward_enabled BOOLEAN DEFAULT TRUE COMMENT '自动转发开关',
    takeover_reason VARCHAR(500) COMMENT '最近接管原因',
    takeover_time DATETIME COMMENT '最近接管时间',
    takeover_by VARCHAR(50) COMMENT '接管人员',
    message_count_today INT DEFAULT 0 COMMENT '今日消息数',
    auto_reply_count_today INT DEFAULT 0 COMMENT '今日自动回复数',
    takeover_count_today INT DEFAULT 0 COMMENT '今日接管次数',
    last_activity_time DATETIME COMMENT '最后活跃时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_chat_room (chat_room),
    INDEX idx_current_status (current_status),
    INDEX idx_last_activity (last_activity_time)
);
```

## 4. API接口设计（基于现有Controller扩展）

### 4.1 扩展MessageController - 群组消息管理

#### 4.1.1 获取群组消息列表（扩展现有接口）
```
GET /api/messages/groups
参数:
- page: 页码 (默认1)
- size: 每页大小 (默认20)
- chatRoom: 群组标识 (可选)
- status: 群组状态筛选 (可选)
- startTime: 开始时间 (可选)
- endTime: 结束时间 (可选)

响应:
{
  "success": true,
  "message": "获取成功",
  "data": {
    "total": 100,
    "page": 1,
    "size": 20,
    "messages": [
      {
        "id": 1,
        "chatRoom": "客户群1@chatroom",
        "senderName": "张三",
        "content": "需要人工客服",
        "groupStatus": "MANUAL",
        "takeoverTrigger": "KEYWORD",
        "isForwarded": true,
        "manualHandled": true,
        "handledBy": "客服小王",
        "receivedAt": "2024-01-15T10:30:00"
      }
    ]
  }
}
```

#### 4.1.2 获取群组统计信息（新增接口）
```
GET /api/messages/groups/statistics
参数:
- chatRoom: 群组标识 (可选，不传则返回所有群组统计)
- date: 统计日期 (可选，默认今天)

响应:
{
  "success": true,
  "message": "获取成功",
  "data": {
    "totalGroups": 10,
    "activeGroups": 8,
    "manualTakeoverGroups": 2,
    "todayMessages": 150,
    "todayAutoReplies": 120,
    "todayTakeovers": 5,
    "groupDetails": [
      {
        "chatRoom": "客户群1@chatroom",
        "groupName": "客户群1",
        "currentStatus": "AUTO",
        "messageCount": 25,
        "autoReplyCount": 20,
        "takeoverCount": 1,
        "lastActivityTime": "2024-01-15T10:30:00"
      }
    ]
  }
}
```

#### 4.1.3 手动切换群组状态（新增接口）
```
POST /api/messages/groups/{chatRoom}/status
请求体:
{
  "action": "MANUAL_TAKEOVER", // AUTO_RESUME, PAUSE, MANUAL_TAKEOVER
  "reason": "客户投诉需要人工处理",
  "operator": "admin"
}

响应:
{
  "success": true,
  "message": "状态切换成功",
  "data": {
    "chatRoom": "客户群1@chatroom",
    "previousStatus": "AUTO",
    "currentStatus": "MANUAL",
    "changeTime": "2024-01-15T10:30:00",
    "operator": "admin"
  }
}
```

### 4.2 扩展BusinessRule - 群组业务规则管理

#### 4.2.1 获取群组相关业务规则（扩展现有接口）
```
GET /api/business-rules
参数:
- ruleType: 规则类型 (GROUP_AUTO_REPLY, GROUP_FORWARD, GROUP_TAKEOVER)
- chatRoom: 群组标识 (可选)
- enabled: 是否启用 (可选)

响应:
{
  "success": true,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "ruleName": "客户群1自动回复规则",
      "ruleType": "GROUP_AUTO_REPLY",
      "priority": 1,
      "enabled": true,
      "conditions": [
        {
          "type": "CHAT_ROOM",
          "value": "客户群1@chatroom",
          "operator": "EQUALS"
        },
        {
          "type": "KEYWORD",
          "value": "价格,报价",
          "operator": "CONTAINS"
        }
      ],
      "actions": [
        {
          "type": "AUTO_REPLY",
          "content": "您好，我们的产品价格请咨询客服..."
        }
      ],
      "effectiveDays": "1,2,3,4,5",
      "startTime": "09:00",
      "endTime": "18:00"
    }
  ]
}
```

#### 4.2.2 创建群组业务规则（扩展现有接口）
```
POST /api/business-rules
请求体:
{
  "ruleName": "客户群2人工接管规则",
  "ruleType": "GROUP_TAKEOVER",
  "priority": 1,
  "enabled": true,
  "conditions": [
    {
      "type": "CHAT_ROOM",
      "value": "客户群2@chatroom",
      "operator": "EQUALS"
    },
    {
      "type": "KEYWORD",
      "value": "投诉,不满意,人工",
      "operator": "CONTAINS"
    }
  ],
  "actions": [
    {
      "type": "MANUAL_TAKEOVER",
      "notificationLevel": "HIGH",
      "managerPhone": "13800138000"
    }
  ]
}

响应:
{
  "success": true,
  "message": "规则创建成功",
  "data": {
    "id": 2,
    "ruleName": "客户群2人工接管规则"
  }
}
```

#### 4.2.3 更新群组业务规则（扩展现有接口）
```
PUT /api/business-rules/{id}
请求体:
{
  "enabled": false,
  "priority": 2,
  "conditions": [
    {
      "type": "CHAT_ROOM",
      "value": "客户群2@chatroom",
      "operator": "EQUALS"
    }
  ]
}

响应:
{
  "success": true,
  "message": "规则更新成功"
}
```

### 4.3 扩展SystemConfig - 群组系统配置管理

#### 4.3.1 获取群组相关系统配置（扩展现有接口）
```
GET /api/system-config
参数:
- configType: 配置类型 (GROUP_MANAGEMENT)
- configKey: 配置键 (可选，如 group.auto.reply.enabled)
- enabled: 是否启用 (可选)

响应:
{
  "success": true,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "configKey": "group.auto.reply.enabled",
      "configValue": "true",
      "description": "群组自动回复总开关",
      "configType": "GROUP_MANAGEMENT",
      "enabled": true
    },
    {
      "id": 2,
      "configKey": "group.takeover.keywords",
      "configValue": "人工,客服,投诉,不满意",
      "description": "全局人工接管关键词",
      "configType": "GROUP_MANAGEMENT",
      "enabled": true
    },
    {
      "id": 3,
      "configKey": "group.notification.manager.phone",
      "configValue": "13800138000",
      "description": "默认管理员手机号",
      "configType": "GROUP_MANAGEMENT",
      "enabled": true
    }
  ]
}
```

#### 4.3.2 更新群组系统配置（扩展现有接口）
```
PUT /api/system-config/{id}
请求体:
{
  "configValue": "false",
  "description": "群组自动回复总开关（已关闭）",
  "enabled": false,
  "remark": "临时关闭进行系统维护"
}

响应:
{
  "success": true,
  "message": "配置更新成功"
}
```

#### 4.3.3 批量更新群组配置（新增接口）
```
PUT /api/system-config/batch
请求体:
{
  "configs": [
    {
      "configKey": "group.auto.reply.enabled",
      "configValue": "true"
    },
    {
      "configKey": "group.takeover.sentiment.threshold",
      "configValue": "-0.5"
    }
  ],
  "operator": "admin"
}

响应:
{
  "success": true,
  "message": "批量更新成功",
  "data": {
    "successCount": 2,
    "failedCount": 0
  }
}
```

### 4.4 监控和统计接口

#### 4.4.1 获取群组统计
```
GET /api/groups/{groupId}/statistics
参数:
- startDate: 开始日期
- endDate: 结束日期

响应:
{
  "code": 200,
  "data": {
    "messageCount": 150,
    "autoReplyCount": 120,
    "manualTakeoverCount": 5,
    "averageResponseTime": 2.5,
    "satisfactionRate": 0.85
  }
}
```

#### 4.4.2 获取接管记录
```
GET /api/groups/{groupId}/takeover-logs
参数:
- page: 页码
- size: 每页大小
- status: 状态筛选

响应:
{
  "code": 200,
  "data": {
    "total": 50,
    "logs": [
      {
        "id": 1,
        "triggerType": "KEYWORD",
        "triggerContent": "用户发送了'人工客服'",
        "triggerTime": "2024-01-15T10:30:00",
        "status": "HANDLED",
        "handledBy": "客服小王",
        "resolution": "问题已解决"
      }
    ]
  }
}
```

## 5. 前端界面设计（基于现有系统扩展）

### 5.1 扩展现有消息管理界面

#### 5.1.1 在现有消息列表页面增加群组功能
- **扩展现有筛选器**：在现有的时间、用户筛选基础上增加群组筛选
- **群组状态标识**：在消息列表中增加群组状态标签（自动/手动/暂停）
- **批量操作扩展**：增加按群组批量操作消息的功能
- **表格列扩展**：
  - 群组名称列
  - 群组状态列（带颜色标识）
  - 接管触发原因列
  - 处理人员列

#### 5.1.2 群组消息详情增强
- **消息卡片扩展**：在现有消息卡片中增加群组状态、接管触发原因等信息
- **快速操作按钮**：增加快速切换群组状态的按钮
- **处理标记**：显示消息是否已人工处理及处理人员

### 5.2 扩展现有业务规则管理界面

#### 5.2.1 在现有规则列表中增加群组规则类型
- **规则类型筛选扩展**：扩展现有规则类型，增加群组相关类型
  - GROUP_AUTO_REPLY（群组自动回复）
  - GROUP_FORWARD（群组转发）
  - GROUP_TAKEOVER（群组接管）
- **群组规则标识**：在规则列表中明确标识群组相关规则

#### 5.2.2 群组规则配置表单（扩展现有表单）
- **条件配置扩展**：在现有条件基础上增加群组相关条件
  - 群组标识匹配
  - 群组消息频率
  - 群组成员行为
- **动作配置扩展**：增加群组特有的动作类型
  - 群组状态切换
  - 群组通知发送
  - 群组管理员指派

### 5.3 扩展现有系统配置界面

#### 5.3.1 在现有配置页面增加群组管理配置项
- **配置分组**：在现有配置分类中增加"群组管理"分类
- **关键配置项**：
  - 群组自动回复总开关
  - 全局接管关键词设置
  - 默认管理员联系方式
  - 情感分析阈值设置

#### 5.3.2 群组状态监控面板（新增独立页面）
```
┌─────────────────────────────────────────────────────────┐
│ 群组管理监控面板                                        │
│ ─────────────────────────────────────────────────────── │
│ 总群组: 10  活跃: 8  自动模式: 6  人工接管: 2  暂停: 0   │
│ ─────────────────────────────────────────────────────── │
│ 群组列表:                                               │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 客户群1@chatroom              [●自动] 消息:25 接管:1│ │
│ │ 客户群2@chatroom              [●手动] 消息:15 接管:3│ │
│ │ 客户群3@chatroom              [●自动] 消息:30 接管:0│ │
│ └─────────────────────────────────────────────────────┘ │
│ [刷新] [批量操作] [导出报告]                            │
└─────────────────────────────────────────────────────────┘
```

### 5.4 统计分析页面（扩展现有统计功能）
- **时间范围选择器**：复用现有组件
- **关键指标卡片**：在现有指标基础上增加群组相关指标
  - 群组总消息数
  - 群组自动回复成功率
  - 群组人工接管次数
  - 群组平均响应时间
- **趋势图表**：扩展现有图表，增加群组维度
- **群组排行榜**：按活跃度、接管频率等排序

## 6. 业务流程设计

### 6.1 自动监控流程
```
消息接收 → 群组配置检查 → 触发条件判断 → 状态更新 → 通知发送
```

### 6.2 人工接管流程
```
触发条件满足 → 自动暂停回复 → 发送通知 → 客服接管 → 问题处理 → 状态恢复
```

### 6.3 配置变更流程
```
配置修改 → 参数验证 → 数据库更新 → 缓存刷新 → 客户端同步
```

## 7. 技术实现要点（基于现有架构扩展）

### 7.1 后端实现（扩展现有Service层）

#### 7.1.1 扩展现有MessageService
```java
@Service
public class MessageService {
    
    // 现有方法保持不变...
    
    // 新增：群组消息处理逻辑
    public void processGroupMessage(Message message) {
        if (message.getIsGroup()) {
            // 1. 检查群组状态
            GroupStatus status = getGroupStatus(message.getChatRoom());
            
            // 2. 根据状态处理消息
            switch (status) {
                case AUTO:
                    handleAutoMode(message);
                    break;
                case MANUAL:
                    handleManualMode(message);
                    break;
                case PAUSED:
                    // 暂停状态不处理
                    break;
            }
            
            // 3. 检查是否需要触发接管
            if (checkTakeoverTriggers(message)) {
                triggerManualTakeover(message.getChatRoom(), "TRIGGER_DETECTED");
            }
        }
    }
    
    // 新增：接管触发检测
    private boolean checkTakeoverTriggers(Message message) {
        // 1. 关键词检测（复用现有KeywordConfig）
        List<KeywordConfig> takeoverKeywords = keywordConfigRepository
            .findByTypeAndIsActive(KeywordType.TAKEOVER, true);
        
        // 2. 情感分析（如果已有相关服务）
        // 3. 重复消息检测
        
        return false; // 实际实现根据具体逻辑
    }
}
```

#### 7.1.2 扩展现有BusinessRuleService
```java
@Service
public class BusinessRuleService {
    
    // 现有方法保持不变...
    
    // 新增：群组规则处理
    public void processGroupRules(Message message) {
        if (message.getIsGroup()) {
            List<BusinessRule> groupRules = businessRuleRepository
                .findByRuleTypeInAndEnabled(
                    Arrays.asList("GROUP_AUTO_REPLY", "GROUP_FORWARD", "GROUP_TAKEOVER"), 
                    true
                );
            
            for (BusinessRule rule : groupRules) {
                if (evaluateRuleConditions(rule, message)) {
                    executeRuleActions(rule, message);
                }
            }
        }
    }
    
    // 扩展：规则条件评估（增加群组相关条件）
    private boolean evaluateRuleConditions(BusinessRule rule, Message message) {
        // 现有逻辑保持不变
        // 新增群组相关条件判断
        for (RuleCondition condition : rule.getConditions()) {
            if ("CHAT_ROOM".equals(condition.getType())) {
                if (!message.getChatRoom().equals(condition.getValue())) {
                    return false;
                }
            }
            // 其他群组相关条件...
        }
        return true;
    }
}
```

#### 7.1.3 新增GroupManagementService
```java
@Service
public class GroupManagementService {
    
    @Autowired
    private SystemConfigService systemConfigService;
    
    @Autowired
    private MessageService messageService;
    
    // 获取群组状态（基于system_config表）
    public GroupStatus getGroupStatus(String chatRoom) {
        String configKey = "group.status." + chatRoom;
        SystemConfig config = systemConfigService.getByConfigKey(configKey);
        return config != null ? 
            GroupStatus.valueOf(config.getConfigValue()) : 
            GroupStatus.AUTO;
    }
    
    // 切换群组状态
    public void switchGroupStatus(String chatRoom, GroupStatus status, String reason, String operator) {
        // 1. 更新系统配置
        String configKey = "group.status." + chatRoom;
        systemConfigService.updateConfig(configKey, status.name(), 
            "群组状态: " + status.getDescription(), operator);
        
        // 2. 记录状态变更日志（可扩展现有日志表）
        recordStatusChange(chatRoom, status, reason, operator);
        
        // 3. 发送实时通知（如果有WebSocket）
        notifyStatusChange(chatRoom, status);
    }
    
    // 群组统计（基于现有Message表）
    public GroupStatistics getGroupStatistics(String chatRoom, LocalDate date) {
        // 利用现有MessageRepository进行统计查询
        return messageRepository.getGroupStatistics(chatRoom, date);
    }
}
```

### 7.2 数据库扩展（最小化改动）

#### 7.2.1 扩展现有表结构
```sql
-- 在messages表中增加群组相关字段（如果还没有）
ALTER TABLE messages ADD COLUMN IF NOT EXISTS group_status VARCHAR(20) DEFAULT 'AUTO';
ALTER TABLE messages ADD COLUMN IF NOT EXISTS takeover_trigger VARCHAR(50);
ALTER TABLE messages ADD COLUMN IF NOT EXISTS manual_handled BOOLEAN DEFAULT FALSE;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS handled_by VARCHAR(100);

-- 在system_config表中增加群组管理相关配置
INSERT INTO system_config (config_key, config_value, description, config_type, enabled) VALUES
('group.auto.reply.enabled', 'true', '群组自动回复总开关', 'GROUP_MANAGEMENT', true),
('group.takeover.keywords', '人工,客服,投诉,不满意', '全局人工接管关键词', 'GROUP_MANAGEMENT', true),
('group.notification.manager.phone', '13800138000', '默认管理员手机号', 'GROUP_MANAGEMENT', true);

-- 在business_rule表中增加群组相关规则类型（如果需要）
-- 现有表结构已支持，只需要在应用层增加新的ruleType
```

#### 7.2.2 新增轻量级状态表
```sql
-- 群组实时状态表（用于快速查询和缓存）
CREATE TABLE IF NOT EXISTS group_management_status (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    chat_room VARCHAR(200) NOT NULL UNIQUE,
    group_name VARCHAR(100),
    current_status VARCHAR(20) DEFAULT 'AUTO',
    last_message_time TIMESTAMP,
    message_count_today INT DEFAULT 0,
    auto_reply_count_today INT DEFAULT 0,
    takeover_count_today INT DEFAULT 0,
    last_takeover_time TIMESTAMP,
    last_takeover_reason VARCHAR(200),
    manager_phone VARCHAR(20),
    manager_email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_chat_room (chat_room),
    INDEX idx_status (current_status),
    INDEX idx_last_message_time (last_message_time)
);
```

### 7.3 前端实现（扩展现有组件）

#### 7.3.1 扩展现有Vuex Store
```javascript
// 在现有store中增加群组管理模块
const store = new Vuex.Store({
  modules: {
    // 现有模块保持不变
    messages: messagesModule,
    businessRules: businessRulesModule,
    systemConfig: systemConfigModule,
    
    // 新增群组管理模块
    groupManagement: {
      namespaced: true,
      state: {
        groupStatuses: {},
        groupStatistics: {},
        realTimeUpdates: true
      },
      mutations: {
        UPDATE_GROUP_STATUS(state, { chatRoom, status }) {
          Vue.set(state.groupStatuses, chatRoom, status);
        },
        SET_GROUP_STATISTICS(state, { chatRoom, statistics }) {
          Vue.set(state.groupStatistics, chatRoom, statistics);
        }
      },
      actions: {
        async switchGroupStatus({ commit }, { chatRoom, status, reason }) {
          // 调用API切换状态
          await api.post(`/api/messages/groups/${chatRoom}/status`, {
            action: status,
            reason: reason
          });
          commit('UPDATE_GROUP_STATUS', { chatRoom, status });
        }
      }
    }
  }
});
```

### 7.4 性能和安全（复用现有机制）

#### 7.4.1 复用现有缓存和安全机制
- **权限控制**: 复用现有RBAC权限体系
- **缓存策略**: 利用现有Redis缓存配置
- **API安全**: 复用现有JWT认证和API限流
- **数据库优化**: 利用现有连接池和查询优化

#### 7.4.2 监控和日志
- **操作日志**: 扩展现有操作日志记录群组管理操作
- **性能监控**: 利用现有监控体系监控群组相关接口
- **异常处理**: 复用现有异常处理机制

### 7.5 容错机制（基于现有架构）
- **通知发送失败重试**: 利用现有消息队列重试机制
- **数据库连接异常处理**: 复用现有数据库连接池异常处理
- **前端网络异常提示**: 扩展现有全局异常处理组件

## 8. 实施计划（基于现有系统扩展）

### 8.1 开发阶段（3周，利用现有架构）

#### 第1周：数据库和后端扩展
- **数据库扩展**（1天）:
  - 在现有messages表中增加群组相关字段
  - 在system_config表中增加群组管理配置
  - 创建group_management_status轻量级状态表

- **后端Service扩展**（4天）:
  - 扩展MessageService增加群组消息处理逻辑
  - 扩展BusinessRuleService增加群组规则处理
  - 新增GroupManagementService核心服务
  - 扩展现有Controller增加群组管理接口

#### 第2周：前端界面扩展
- **消息管理界面扩展**（2天）:
  - 在现有消息列表中增加群组筛选和状态显示
  - 扩展消息详情页面增加群组操作按钮

- **业务规则界面扩展**（2天）:
  - 在现有规则管理中增加群组规则类型
  - 扩展规则配置表单支持群组条件和动作

- **系统配置界面扩展**（1天）:
  - 在现有配置页面中增加群组管理配置项
  - 新增群组状态监控面板页面

#### 第3周：集成测试和优化
- **功能集成测试**（3天）:
  - 测试群组消息处理流程
  - 测试状态切换和规则触发
  - 测试前后端数据交互

- **性能优化和文档**（2天）:
  - 优化数据库查询和缓存策略
  - 完善API文档和用户手册

### 8.2 测试阶段（1周）

#### 第4周：全面测试
- **功能测试**（2天）:
  - 群组状态切换测试
  - 自动接管触发测试
  - 规则配置和执行测试

- **集成测试**（2天）:
  - 与现有消息系统集成测试
  - 与现有业务规则系统集成测试
  - 数据一致性验证

- **用户验收测试**（1天）:
  - 业务人员功能验收
  - 界面易用性测试

### 8.3 部署阶段（0.5周）

#### 第4.5周：生产部署
- **数据库升级**（半天）:
  - 执行数据库扩展脚本
  - 初始化群组管理配置数据

- **应用部署**（半天）:
  - 部署后端扩展功能
  - 部署前端界面更新
  - 验证功能正常运行

## 9. 风险评估和缓解措施

### 9.1 技术风险（低风险）
- **现有系统兼容性风险**: 扩展可能影响现有功能
  - **缓解措施**: 基于现有架构扩展，最小化代码改动，充分测试
  - **风险等级**: 低

- **数据库性能风险**: 新增字段和查询可能影响性能
  - **缓解措施**: 合理设计索引，利用现有缓存机制
  - **风险等级**: 低

### 9.2 业务风险（中等风险）
- **自动接管误判风险**: 可能出现不必要的人工接管
  - **缓解措施**: 提供灵活的规则配置和快速恢复机制
  - **风险等级**: 中

- **用户适应性风险**: 用户需要学习新的操作界面
  - **缓解措施**: 基于现有界面扩展，保持操作习惯一致性
  - **风险等级**: 低

### 9.3 实施风险（低风险）
- **开发周期风险**: 可能超出预期开发时间
  - **缓解措施**: 基于现有架构扩展，减少开发复杂度
  - **风险等级**: 低

- **数据迁移风险**: 现有数据可能需要处理
  - **缓解措施**: 新增字段设置默认值，不影响现有数据
  - **风险等级**: 极低

## 10. 成功标准

### 10.1 功能标准
- ✅ 群组消息能够根据配置自动处理
- ✅ 支持手动切换群组状态（自动/手动/暂停）
- ✅ 关键词触发人工接管功能正常
- ✅ 群组统计和监控数据准确
- ✅ 与现有系统无缝集成

### 10.2 性能标准
- ✅ 群组消息处理延迟 < 500ms
- ✅ 状态切换响应时间 < 200ms
- ✅ 支持至少100个活跃群组同时运行
- ✅ 系统资源占用增加 < 10%

### 10.3 用户体验标准
- ✅ 界面操作直观，学习成本低
- ✅ 状态变化有明确的视觉反馈
- ✅ 异常情况有清晰的提示信息
- ✅ 移动端能够进行基本的群组管理操作

## 11. 风险评估

### 11.1 技术风险
- **数据一致性**：多个系统同时修改群组状态可能导致数据不一致
- **性能瓶颈**：大量群组同时监控可能影响系统性能
- **实时性要求**：网络延迟可能影响实时通知效果

### 11.2 业务风险
- **误操作风险**：批量操作可能影响正常业务
- **通知延迟**：关键时刻通知不及时可能影响客户体验
- **配置错误**：错误的阈值设置可能导致频繁误报

### 11.3 应对策略
- 实施数据库事务和锁机制
- 建立完善的监控和告警系统
- 设计回滚机制和紧急处理流程
- 提供配置验证和预览功能